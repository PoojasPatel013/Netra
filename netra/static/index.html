<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netra Intelligence Platform</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        radium: { 50: '#e0fbff', 100: '#bdf6ff', 200: '#8aefff', 300: '#46e6ff', 400: '#00d5ff', 500: '#00f3ff', 600: '#008ba3', 800: '#005a6b' },
                        cyber: { black: '#050a14', dark: '#0b1221', border: '#1e293b', text: '#e2e8f0' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                        display: ['Orbitron', 'sans-serif'],
                        serif: ['"Playfair Display"', 'serif'],
                    },
                    animation: {
                        'scan': 'scan 3s linear infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(100%)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [x-cloak] {
            display: none !important;
        }

        .glass {
            background: rgba(11, 18, 33, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-light {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .text-glow {
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }

        .scan-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, #00f3ff, transparent);
            position: absolute;
            animation: scan 2s linear infinite;
        }
    </style>
</head>

<body
    class="bg-gray-50 dark:bg-cyber-black text-slate-900 dark:text-cyber-text transition-colors duration-300 min-h-screen font-sans overflow-x-hidden"
    x-data="app()" x-init="initApp()">

    <!-- AUTHENTICATION & LANDING PAGE -->
    <template x-if="!isAuthenticated">
        <div
            class="fixed inset-0 z-50 flex flex-col md:flex-row h-screen w-full bg-cyber-black overflow-hidden relative">
            <!-- Background Elements -->
            <div
                class="absolute inset-0 bg-[url('https://res.cloudinary.com/practicaldev/image/fetch/s--_MFOcsk1--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zjvcvp3y03029202512.png')] bg-cover opacity-10 blur-sm pointer-events-none">
            </div>
            <div
                class="absolute inset-0 bg-gradient-to-b from-transparent via-cyber-black/80 to-cyber-black pointer-events-none">
            </div>

            <!-- LEFT: Authentication Form -->
            <div class="w-full md:w-1/2 flex items-center justify-center p-8 md:p-16 relative z-10">
                <div
                    class="w-full max-w-md bg-cyber-dark/80 backdrop-blur-xl border border-slate-700/50 p-10 rounded-2xl shadow-2xl relative overflow-hidden group">
                    <!-- Scan Line -->
                    <div class="absolute top-0 left-0 w-full h-1 bg-radium-500 shadow-[0_0_15px_#00f3ff] opacity-50">
                    </div>

                    <div class="mb-8 text-center">
                        <h1 class="font-display font-bold text-5xl text-white mb-2 tracking-tighter">NETRA</h1>
                        <p class="text-radium-500 font-mono text-xs uppercase tracking-[0.3em]">Surveillance &
                            Intelligence Grid</p>
                    </div>

                    <!-- Alpine Listener for Node Selection -->
                    <div @node-selected.window="selectedNode = $event.detail; activeTab = 'dashboard'"
                        style="display:none;"></div>


                    <form @submit.prevent="handleAuth" class="space-y-6">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Agent Identity</label>
                            <div class="relative">
                                <i data-lucide="user" class="absolute left-3 top-3 w-5 h-5 text-slate-500"></i>
                                <input type="text" x-model="authForm.username" required
                                    class="w-full bg-black/50 border border-slate-700 rounded pl-10 pr-4 py-3 text-white font-mono placeholder-slate-600 focus:border-radium-500 focus:ring-1 focus:ring-radium-500 transition-all outline-none"
                                    placeholder="Enter user ID">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Access Key</label>
                            <div class="relative">
                                <i data-lucide="lock" class="absolute left-3 top-3 w-5 h-5 text-slate-500"></i>
                                <input type="password" x-model="authForm.password" required
                                    class="w-full bg-black/50 border border-slate-700 rounded pl-10 pr-4 py-3 text-white font-mono placeholder-slate-600 focus:border-radium-500 focus:ring-1 focus:ring-radium-500 transition-all outline-none"
                                    placeholder="••••••••">
                            </div>
                        </div>

                        <button type="submit"
                            class="w-full bg-radium-600 hover:bg-radium-500 text-black font-display font-bold uppercase tracking-widest py-4 rounded transition-all transform hover:scale-[1.02] shadow-[0_0_20px_rgba(0,243,255,0.3)] flex items-center justify-center gap-2">
                            <span x-text="authMode === 'login' ? 'Establish Link' : 'Register Identity'"></span>
                            <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                    </form>

                    <div class="mt-6 text-center border-t border-slate-800 pt-4">
                        <button @click="authMode = authMode === 'login' ? 'register' : 'login'"
                            class="text-xs text-slate-400 hover:text-white transition-colors">
                            <span
                                x-text="authMode === 'login' ? 'Request New Clearance (Register)' : 'Return to Login'"></span>
                        </button>
                    </div>
                    <div x-show="authError"
                        class="mt-4 p-3 bg-red-900/30 border border-red-500 rounded text-red-400 text-xs text-center font-mono"
                        x-text="authError"></div>
                </div>
            </div>

            <!-- RIGHT: Instructions & Safety -->
            <div
                class="hidden md:flex w-1/2 bg-slate-900/50 backdrop-blur-md border-l border-slate-800 p-16 flex-col justify-center relative">
                <div class="max-w-lg mx-auto space-y-12">

                    <!-- Safety Warning -->
                    <div class="border-l-4 border-red-500 pl-6 py-2">
                        <h3 class="text-red-500 font-display font-bold text-2xl mb-2 flex items-center gap-2">
                            <i data-lucide="shield-alert" class="w-6 h-6"></i> Authorized Use Only
                        </h3>
                        <p class="text-slate-400 text-sm leading-relaxed text-justify">
                            This system allows for active reconnaissance and simulated engagement.
                            Unauthorized use against targets without explicit written consent is a violation of federal
                            and international law (CFAA, GDPR).
                            All actions are logged and auditable. Proceed only for authorized security testing or
                            educational research.
                        </p>
                    </div>

                    <!-- App Overview -->
                    <div class="space-y-6">
                        <h3
                            class="text-white font-display font-bold text-xl uppercase tracking-widest border-b border-slate-700 pb-2">
                            System Capabilities</h3>

                        <div class="flex gap-4 items-start">
                            <div class="p-2 rounded bg-blue-900/20 text-blue-400 mt-1"><i data-lucide="scan"
                                    class="w-5 h-5"></i></div>
                            <div>
                                <h4 class="text-white font-bold text-sm">Deep Reconnaissance</h4>
                                <p class="text-slate-500 text-xs mt-1">Automated asset discovery, port scanning, and
                                    banner grabbing via distributed drones.</p>
                            </div>
                        </div>

                        <div class="flex gap-4 items-start">
                            <div class="p-2 rounded bg-purple-900/20 text-purple-400 mt-1"><i data-lucide="network"
                                    class="w-5 h-5"></i></div>
                            <div>
                                <h4 class="text-white font-bold text-sm">Graph Visualization</h4>
                                <p class="text-slate-500 text-xs mt-1">Real-time Neo4j mapping of infrastructure
                                    relationships and potential attack vectors.</p>
                            </div>
                        </div>

                        <div class="flex gap-4 items-start">
                            <div class="p-2 rounded bg-red-900/20 text-red-400 mt-1"><i data-lucide="zap"
                                    class="w-5 h-5"></i></div>
                            <div>
                                <h4 class="text-white font-bold text-sm">Polyglot Scanning</h4>
                                <p class="text-slate-500 text-xs mt-1">Hybrid Python/Ruby engine capable of running
                                    legacy exploit scripts (Metasploit/WPScan simulation).</p>
                            </div>
                        </div>
                    </div>

                    <div class="pt-12 text-center">
                        <p class="font-mono text-[10px] text-slate-600">SECURE TERMINAL ACCESS // V2.0.4-BETA</p>
                    </div>

                </div>
            </div>
        </div>
    </template>

    <!-- MAIN DASHBOARD CONTENT (Authenticated) -->
    <main x-show="isAuthenticated" x-cloak class="min-h-screen flex flex-col">

        <!-- Header / Masthead -->
        <header
            class="border-b-4 border-double border-slate-900 dark:border-slate-700 bg-white dark:bg-cyber-black relative z-40">
            <!-- Top Utility Bar -->
            <div
                class="flex items-center justify-between px-4 md:px-8 py-2 border-b border-slate-300 dark:border-slate-800 text-xs font-serif italic text-slate-600 dark:text-slate-400">
                <div class="flex items-center gap-4">
                    <span
                        x-text="new Date().toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })"></span>
                    <span class="hidden md:inline">|</span>
                    <span class="hidden md:inline">Vol. 2, No. 42</span>
                    <span class="hidden md:inline">|</span>
                    <span class="hidden md:inline">Data Isolation: ACTIVE</span>
                </div>
                <div class="flex items-center gap-4">
                    <button @click="toggleTheme()" class="hover:text-radium-500 transition-colors">
                        <i data-lucide="sun" x-show="!darkMode" class="w-4 h-4"></i>
                        <i data-lucide="moon" x-show="darkMode" class="w-4 h-4"></i>
                    </button>
                    <div class="flex items-center gap-2 group cursor-pointer relative" @click="logout()">
                        <i data-lucide="user" class="w-3 h-3"></i>
                        <span class="font-bold uppercase" x-text="currentUser?.username || 'AGENT'"></span>
                        <span
                            class="text-[10px] opacity-0 group-hover:opacity-100 transition-opacity text-red-500 ml-1">(LOGOUT)</span>
                    </div>
                </div>
            </div>

            <!-- Title -->
            <div class="py-6 text-center relative overflow-hidden group">
                <h1
                    class="text-4xl md:text-7xl font-serif font-black tracking-tighter text-slate-900 dark:text-slate-100 mb-2 relative z-10 selection:bg-radium-500 selection:text-black">
                    The Netra Times
                </h1>
                <div class="h-1 w-24 bg-slate-900 dark:bg-slate-100 mx-auto mb-1"></div>
                <div class="h-0.5 w-full max-w-xl bg-slate-900 dark:bg-slate-100 mx-auto"></div>
                <p class="mt-2 font-display text-xs tracking-[0.3em] text-slate-500 dark:text-radium-500 uppercase">
                    Advanced Security Monitoring & Intelligence
                </p>
                <!-- BG Decor -->
                <i data-lucide="shield"
                    class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 text-slate-200/50 dark:text-slate-800/20 -z-0 opacity-20 rotate-12"></i>
            </div>

            <!-- NavBar -->
            <nav
                class="flex justify-center border-t border-b border-slate-300 dark:border-slate-700 py-3 sticky top-0 bg-white/95 dark:bg-cyber-black/95 backdrop-blur z-50">
                <ul class="flex flex-wrap justify-center gap-4 md:gap-8 px-4">
                    <template x-for="item in menuItems" :key="item.id">
                        <li>
                            <template x-if="!item.url">
                                <button @click="activeTab = item.id"
                                    :class="activeTab === item.id ? 'text-radium-600 dark:text-radium-500 scale-105' : 'text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200'"
                                    class="relative px-2 py-1 font-serif text-sm md:text-base font-bold tracking-wider transition-all duration-300">
                                    <span x-text="item.label"></span>
                                    <div x-show="activeTab === item.id"
                                        class="absolute -bottom-2 left-0 right-0 h-0.5 bg-radium-600 dark:bg-radium-500">
                                    </div>
                                </button>
                            </template>
                            <template x-if="item.url">
                                <a :href="item.url"
                                    class="relative px-2 py-1 font-serif text-sm md:text-base font-bold tracking-wider transition-all duration-300 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200">
                                    <span x-text="item.label"></span>
                                </a>
                            </template>
                        </li>
                    </template>
                </ul>
            </nav>
        </header>

        <!-- DASHBOARD CONTENT -->
        <div class="flex-grow max-w-7xl mx-auto w-full p-4 md:p-8">

            <!-- VIEW: FRONT PAGE -->
            <div x-show="activeTab === 'dashboard'" x-transition.opacity.duration.300ms>
                <!-- Existing Dashboard Layout -->
                <div class="mb-6 border-b-2 border-slate-900 dark:border-slate-100 pb-2">
                    <div class="flex flex-wrap gap-4 justify-between items-end">
                        <div class="flex items-center gap-2">
                            <span
                                class="bg-red-600 text-white px-2 py-0.5 font-bold text-[10px] uppercase tracking-widest animate-pulse">LIVE
                                FEED</span>
                            <span class="font-serif italic text-sm text-slate-700 dark:text-slate-300">System
                                functionality restored. Agent login confirmed.</span>
                        </div>
                        <div class="font-mono text-[10px] text-slate-500">
                            SCANS {<span x-text="stats.scans"></span>} | VULNS {<span x-text="stats.vulns"></span>} |
                            ASSETS {<span x-text="stats.assets"></span>}
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <!-- Left: Controls -->
                    <div class="lg:col-span-5 space-y-6">
                        <div
                            class="bg-white dark:bg-cyber-dark p-6 shadow-xl border border-slate-200 dark:border-slate-800 relative">
                            <div class="border-b-4 border-double border-slate-800 dark:border-slate-600 mb-4 pb-2">
                                <h2
                                    class="font-serif font-black text-2xl text-slate-900 dark:text-slate-100 leading-none">
                                    TARGET ACQUISITION</h2>
                            </div>

                            <div class="mb-4">
                                <label
                                    class="block font-sans text-xs font-bold uppercase tracking-widest mb-1 text-slate-500">Target
                                    URI</label>
                                <div class="flex gap-2">
                                    <input type="text" x-model="target" placeholder="example.com"
                                        class="w-full bg-slate-100 dark:bg-black border-b-2 border-slate-800 dark:border-slate-200 px-4 py-2 text-xl font-serif text-slate-900 dark:text-white focus:outline-none focus:bg-yellow-50 dark:focus:bg-gray-900 transition-colors">
                                    <button @click="loadDashboardData()" title="Refresh Data"
                                        class="hover:bg-slate-200 dark:hover:bg-slate-800 p-2 rounded"><i
                                            data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                                </div>
                            </div>

                            <div
                                class="bg-slate-100 dark:bg-black p-4 border border-slate-300 dark:border-slate-700 mb-6">
                                <h3
                                    class="font-sans font-bold text-xs uppercase text-slate-500 mb-2 border-b border-slate-300 pb-1">
                                    Scan Profiles</h3>
                                <div class="grid grid-cols-2 gap-y-2">
                                    <template x-for="(val, key) in options" :key="key">
                                        <label
                                            class="flex items-center space-x-2 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-800 p-1 rounded">
                                            <input type="checkbox" x-model="options[key]"
                                                class="text-slate-900 rounded-none w-4 h-4">
                                            <span x-text="key"
                                                class="font-serif text-sm text-slate-700 dark:text-slate-300 italic"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>

                            <button @click="startScan()" :disabled="scanning"
                                class="w-full py-4 border-2 border-slate-900 dark:border-white font-bold font-sans tracking-widest uppercase transition-all hover:bg-slate-900 hover:text-white dark:hover:bg-white dark:hover:text-black disabled:opacity-50 disabled:cursor-not-allowed mb-2">
                                <span x-text="scanning ? 'TRANSMITTING...' : 'LAUNCH OPERATION'"></span>
                            </button>
                            <div x-show="scanning" class="text-center font-mono text-xs text-radium-600 animate-pulse">
                                STATUS: <span x-text="scanStatus"></span></div>

                            <!-- Logs -->
                            <div x-show="logs.length > 0"
                                class="mt-4 p-2 bg-black text-green-400 font-mono text-[10px] h-32 overflow-y-auto border border-slate-700">
                                <template x-for="log in logs">
                                    <div x-text="log"></div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Tagging UI (Appears when Node Selected) -->
                    <div class="lg:col-span-12" x-show="selectedNode">
                        <div
                            class="bg-radium-500/10 border border-radium-500/50 p-4 rounded flex items-center justify-between">
                            <div class="text-radium-400 font-mono text-xs">
                                SELECTED: <span class="font-bold" x-text="selectedNode.label || selectedNode.id"></span>
                                (<span x-text="selectedNode.group"></span>)
                            </div>
                            <div class="flex gap-2">
                                <input type="text" placeholder="Add Tag (e.g. Critical)" id="tagInput"
                                    class="bg-black border border-slate-700 text-white px-2 py-1 text-xs rounded focus:outline-none focus:border-radium-500">
                                <button
                                    @click="fetch('/api/graph/tag', {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('netra_token')},
                                        body: JSON.stringify({ node_id: selectedNode.id, tag: document.getElementById('tagInput').value })
                                    }).then(r=>r.json()).then(d=>{ alert('Tagged!'); selectedNode.properties.tag = d.tag; selectedNode=null; })"
                                    class="bg-radium-600 hover:bg-radium-500 text-black font-bold text-xs px-3 py-1 rounded">
                                    APPLY
                                </button>
                                <button @click="selectedNode = null" class="text-slate-500 hover:text-white"><i
                                        data-lucide="x" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Results -->
                    <div class="lg:col-span-7">
                        <div
                            class="bg-white dark:bg-cyber-dark shadow-2xl p-8 min-h-[500px] border border-slate-200 dark:border-slate-800 relative">
                            <div class="text-center mb-6">
                                <h2 class="font-serif font-bold text-3xl mb-1 text-slate-900 dark:text-white">Analysis
                                    Report</h2>
                            </div>

                            <div x-show="!results"
                                class="flex flex-col items-center justify-center h-48 border-4 border-double border-slate-200 dark:border-slate-700 p-8 text-center text-slate-400 italic font-serif">
                                <i data-lucide="shield" class="w-12 h-12 mb-4"
                                    :class="scanning ? 'animate-pulse text-slate-800 dark:text-white' : ''"></i>
                                <span
                                    x-text="scanning ? 'Receiving transmission...' : 'Awaiting Mission Directives.'"></span>
                            </div>

                            <div x-show="results" class="space-y-6 text-sm">
                                <!-- Quick Stats -->
                                <div class="grid grid-cols-3 gap-4 border-b border-slate-700 pb-4 mb-4">
                                    <div class="text-center">
                                        <div class="text-xs text-slate-500 uppercase">Ports</div>
                                        <div class="text-2xl font-mono"
                                            x-text="results?.PortScanner?.open_ports?.length || 0"></div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-slate-500 uppercase">Threats</div>
                                        <div class="text-2xl font-mono text-red-500"
                                            x-text="results?.ThreatScanner?.vulnerabilities?.length || 0"></div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-slate-500 uppercase">Latency</div>
                                        <div class="text-2xl font-mono text-green-500">42ms</div>
                                    </div>
                                </div>

                                <!-- Vuln List -->
                                <template x-for="v in results?.ThreatScanner?.vulnerabilities || []">
                                    <div class="border-l-4 border-red-500 pl-4 py-1">
                                        <h4 class="font-bold text-red-500" x-text="v.type"></h4>
                                        <p class="text-slate-400 text-xs" x-text="v.details"></p>
                                    </div>
                                </template>

                                <div x-show="results" class="mt-4 pt-4 border-t border-slate-700 flex justify-end">
                                    <button @click="downloadResults()"
                                        class="text-xs font-bold uppercase hover:text-radium-500 flex items-center gap-2">
                                        <i data-lucide="download" class="w-4 h-4"></i> Export JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: CLASSIFIEDS (Scan History) -->
            <div x-show="activeTab === 'classifieds'" x-transition.opacity.duration.300ms>
                <div class="bg-white dark:bg-cyber-dark p-8 border border-slate-200 dark:border-slate-800 shadow-xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-serif font-bold dark:text-white">Classified Archives</h2>
                        <button @click="loadScanHistory()" class="bg-slate-200 dark:bg-slate-800 p-2 rounded"><i
                                data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                    </div>

                    <table class="w-full text-left font-serif text-sm">
                        <thead class="border-b-2 border-slate-900 dark:border-slate-100">
                            <tr>
                                <th class="py-2">Operation ID</th>
                                <th class="py-2">Target</th>
                                <th class="py-2">Status</th>
                                <th class="py-2">Date</th>
                                <th class="py-2 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700">
                            <template x-for="s in scanHistory" :key="s.id">
                                <tr class="hover:bg-slate-100 dark:hover:bg-slate-800/50">
                                    <td class="py-3 font-mono text-xs text-slate-500" x-text="s.id"></td>
                                    <td class="py-3 font-bold text-lg" x-text="s.target"></td>
                                    <td class="py-3">
                                        <span x-text="s.status.toUpperCase()"
                                            :class="{'text-green-500': s.status==='completed', 'text-yellow-500': s.status==='running', 'text-red-500': s.status==='failed'}"
                                            class="text-xs font-bold tracking-widest"></span>
                                    </td>
                                    <td class="py-3 text-xs text-slate-500"
                                        x-text="new Date(s.timestamp).toLocaleDateString()"></td>
                                    <td class="py-3 text-right space-x-2">
                                        <button @click="loadScanForInvestigation(s)"
                                            class="text-blue-400 hover:text-blue-300 font-bold text-xs uppercase underline">View
                                            Intel</button>
                                        <button @click="deleteScan(s.id)" class="text-red-400 hover:text-red-300"><i
                                                data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="scanHistory.length === 0">
                                <td colspan="5" class="py-8 text-center italic text-slate-500">No records found.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: INVESTIGATIONS (Visuals) -->
            <div x-show="activeTab === 'investigations'" x-transition.opacity.duration.300ms>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Sidebar Selection -->
                    <div class="md:col-span-1 bg-white dark:bg-cyber-dark p-4 border border-slate-700">
                        <h3 class="font-bold text-slate-400 uppercase text-xs mb-4">Select Operation</h3>
                        <div class="space-y-2 max-h-[500px] overflow-y-auto">
                            <template x-for="s in scanHistory" :key="s.id">
                                <button @click="loadScanForInvestigation(s)"
                                    :class="selectedScan?.id === s.id ? 'bg-radium-600 text-black' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'"
                                    class="w-full text-left p-3 text-xs font-mono rounded transition-colors truncate">
                                    <div class="font-bold" x-text="s.target"></div>
                                    <div class="opacity-70" x-text="new Date(s.timestamp).toLocaleDateString()"></div>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Neural Engine Status -->
                    <div
                        class="mt-6 md:col-span-1 bg-gradient-to-br from-slate-900 to-slate-950 p-6 rounded-xl border border-slate-800 shadow-xl relative overflow-hidden group">
                        <!-- Glow Effect -->
                        <div
                            class="absolute top-0 right-0 w-32 h-32 bg-radium-500/10 blur-[50px] rounded-full transition-all group-hover:bg-radium-500/20">
                        </div>

                        <h3 class="font-sans font-bold text-white text-sm tracking-wide mb-6 flex items-center gap-2">
                            <div class="p-1.5 bg-radium-500/10 rounded-lg">
                                <i data-lucide="brain-circuit" class="w-4 h-4 text-radium-400"></i>
                            </div>
                            NEURAL INTELLIGENCE
                        </h3>

                        <div class="space-y-4">
                            <!-- Core -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-8 w-1 bg-green-500/50 rounded-full"></div>
                                    <div>
                                        <div class="text-xs font-bold text-slate-200">Event Loop</div>
                                        <div class="text-[10px] text-slate-500">Async Non-Blocking</div>
                                    </div>
                                </div>
                                <span
                                    class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-green-500/10 border border-green-500/20 text-[10px] font-bold text-green-400">
                                    <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                                    ACTIVE
                                </span>
                            </div>

                            <!-- Traffic -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-8 w-1 bg-blue-500/50 rounded-full"></div>
                                    <div>
                                        <div class="text-xs font-bold text-slate-200">Traffic Opt.</div>
                                        <div class="text-[10px] text-slate-500">Smart Rate Limiting</div>
                                    </div>
                                </div>
                                <span
                                    class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-[10px] font-bold text-blue-400">
                                    OPTIMIZED
                                </span>
                            </div>

                            <!-- ML Model -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-8 w-1 bg-purple-500/50 rounded-full"></div>
                                    <div>
                                        <div class="text-xs font-bold text-slate-200">Risk Engine</div>
                                        <div class="text-[10px] text-slate-500">v1.2 Random Forest</div>
                                    </div>
                                </div>
                                <span
                                    class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-purple-500/10 border border-purple-500/20 text-[10px] font-bold text-purple-400">
                                    <span class="w-1.5 h-1.5 rounded-full bg-purple-400 animate-pulse"></span>
                                    ONLINE
                                </span>
                            </div>

                            <!-- Zombie API -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-8 w-1 bg-yellow-500/50 rounded-full"></div>
                                    <div>
                                        <div class="text-xs font-bold text-slate-200">Zombie API</div>
                                        <div class="text-[10px] text-slate-500">NLP TinyLLM v1</div>
                                    </div>
                                </div>
                                <span
                                    class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-yellow-500/10 border border-yellow-500/20 text-[10px] font-bold text-yellow-400">
                                    <span class="w-1.5 h-1.5 rounded-full bg-yellow-400 animate-pulse"></span>
                                    ACTIVE
                                </span>
                            </div>

                            <!-- AI Terminal Output -->
                            <div
                                class="mt-3 bg-black/50 rounded p-2 border border-slate-800 font-mono text-[10px] text-green-400 overflow-hidden relative">
                                <div class="absolute top-0 left-0 w-1 h-full bg-green-500 animate-pulse"></div>
                                <span class="pl-2 opacity-70">> NEURAL NET: </span>
                                <span id="ai-terminal-text" class="text-green-300">Scanning... waiting for input.</span>
                            </div>

                        </div>
                    </div>

                    <!-- Main Visuals -->
                    <!-- Main Visuals (Newspaper Layout) -->
                    <div class="md:col-span-3 grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <!-- Col 1 (Wide): Knowledge Graph (Hero) -->
                        <div
                            class="lg:col-span-2 flex flex-col h-[650px] bg-cyber-black rounded-xl border border-slate-800 shadow-2xl relative overflow-hidden group">

                            <!-- Glass Header -->
                            <div
                                class="absolute top-0 w-full p-6 bg-gradient-to-b from-black/80 to-transparent z-10 flex justify-between items-start pointer-events-none">
                                <div>
                                    <h2
                                        class="text-2xl font-sans font-bold text-white tracking-tight flex items-center gap-2">
                                        <i data-lucide="network" class="w-6 h-6 text-radium-500"></i> Asset Map
                                    </h2>
                                    <div class="text-xs text-slate-400 font-mono mt-1">
                                        Nodes: <span id="node-count" class="text-white font-bold">0</span> |
                                        Edges: <span id="edge-count" class="text-white font-bold">0</span>
                                    </div>
                                </div>
                                <div class="pointer-events-auto flex items-center gap-2">
                                    <button onclick="predictShadowIT()"
                                        class="px-3 py-1.5 bg-yellow-500/10 border border-yellow-500/20 text-yellow-400 text-xs font-bold rounded hover:bg-yellow-500/20 transition-all flex items-center gap-1.5">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i> Predict Shadow Links
                                    </button>
                                    <div
                                        class="px-3 py-1 bg-slate-900/80 backdrop-blur rounded-full border border-slate-700/50 flex items-center gap-2">
                                        <div class="w-2 h-2 rounded-full bg-radium-500 animate-pulse"></div>
                                        <span class="text-[10px] font-bold text-radium-400">LIVE</span>
                                    </div>
                                </div><span id="graphStatus"
                                    class="font-mono text-[10px] text-radium-400 bg-radium-500/10 px-2 py-1 rounded border border-radium-500/20">
                                    CONNECTING...
                                </span>
                            </div>

                            <!-- D3 Canvas -->
                            <div id="graph" class="flex-1 w-full h-full relative z-0"></div>

                            <!-- Footer Scanline -->
                            <div
                                class="h-1 w-full bg-gradient-to-r from-transparent via-radium-500/50 to-transparent absolute bottom-0 opacity-50">
                            </div>
                        </div>

                        <!-- Col 2 (Right Sidebar): High Frequency Data -->
                        <div class="lg:col-span-1 space-y-4 h-[650px] overflow-y-auto no-scrollbar">

                            <!-- Risk Card -->
                            <div class="bg-black/80 p-5 rounded-xl border border-slate-800 backdrop-blur-sm">
                                <h4
                                    class="text-[10px] font-bold uppercase text-slate-500 mb-4 tracking-widest border-b border-slate-800 pb-2">
                                    Risk Trajectory</h4>
                                <div class="h-32">
                                    <canvas id="lineChart"></canvas>
                                </div>
                            </div>

                            <!-- Vuln Card -->
                            <div class="bg-black/80 p-5 rounded-xl border border-slate-800 backdrop-blur-sm">
                                <h4
                                    class="text-[10px] font-bold uppercase text-slate-500 mb-4 tracking-widest border-b border-slate-800 pb-2">
                                    Threat Spectrum</h4>
                                <div class="h-40 relative">
                                    <canvas id="pieChart"></canvas>
                                    <!-- Center Count -->
                                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <span class="text-2xl font-bold text-white opacity-20">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Ports Card -->
                            <div class="bg-black/80 p-5 rounded-xl border border-slate-800 backdrop-blur-sm flex-1">
                                <h4
                                    class="text-[10px] font-bold uppercase text-slate-500 mb-4 tracking-widest border-b border-slate-800 pb-2">
                                    Surface Exposure</h4>
                                <div class="h-40">
                                    <canvas id="barChart"></canvas>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <!-- App Logic -->
    <script>
        window.netraGraph = { svg: null, simulation: null };

        function app() {
            return {
                isAuthenticated: false,
                authMode: 'login',
                authForm: { username: '', password: '' },
                authError: null,
                currentUser: null,

                activeTab: 'dashboard',
                darkMode: true,
                target: '',
                scanning: false,
                scanStatus: 'IDLE',
                logs: [],
                results: null,
                stats: { scans: 0, vulns: 0, assets: 0 },
                options: { Cloud: false, IoT: false, GraphQL: false, Acquisitions: false, AutoExploit: false },

                scanHistory: [],
                selectedScan: null,
                selectedNode: null, // For Graph Tagging

                // Chart Instances
                charts: { pie: null, bar: null, line: null },

                menuItems: [
                    { id: 'dashboard', label: 'FRONT PAGE' },
                    { id: 'classifieds', label: 'CLASSIFIEDS (HISTORY)' },
                    { id: 'investigations', label: 'INVESTIGATIONS' },
                    { id: 'neural', label: 'NEURAL GRID', url: '/neural.html' },
                ],

                initApp: function () {
                    const savedTheme = localStorage.getItem('netra-theme');
                    this.darkMode = savedTheme ? JSON.parse(savedTheme) : true;
                    this.applyTheme();
                    this.checkAuth();
                    if (typeof lucide !== 'undefined') {
                        this.$nextTick(() => lucide.createIcons());
                    }

                    this.$watch('activeTab', (val) => {
                        if (typeof lucide !== 'undefined') {
                            this.$nextTick(() => lucide.createIcons());
                        }
                        if (val === 'classifieds') this.loadScanHistory();
                        if (val === 'investigations') {
                            setTimeout(() => {
                                this.initGraph();
                                this.initCharts();
                                if (!this.selectedScan && this.scanHistory.length > 0) this.loadScanForInvestigation(this.scanHistory[0]);
                            }, 200);
                        }
                    });
                },

                checkAuth: function () {
                    const token = localStorage.getItem('netra_token');
                    if (token) {
                        this.isAuthenticated = true;
                        this.fetchUserProfile();
                        this.loadDashboardData();
                        this.loadScanHistory(); // Preload history
                    }
                },

                handleAuth: async function () {
                    this.authError = null;
                    const endpoint = this.authMode === 'login' ? '/token' : '/auth/register';
                    const formData = new URLSearchParams();
                    formData.append('username', this.authForm.username);
                    formData.append('password', this.authForm.password);

                    try {
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: formData
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || 'Access Denied');
                        }

                        const data = await res.json();
                        localStorage.setItem('netra_token', data.access_token);
                        this.isAuthenticated = true;
                        this.authForm = { username: '', password: '' }; // Clear
                        this.loadDashboardData();
                        this.fetchUserProfile();
                        this.loadScanHistory();

                    } catch (e) {
                        this.authError = e.message;
                    }
                },

                logout: function () {
                    localStorage.removeItem('netra_token');
                    this.isAuthenticated = false;
                    this.results = null;
                },

                fetchUserProfile: async function () {
                    const token = localStorage.getItem('netra_token');
                    if (!token) return;
                    try {
                        const res = await fetch('/users/me', { headers: { 'Authorization': `Bearer ${token}` } });
                        if (res.ok) {
                            this.currentUser = await res.json();
                            // Load Preferences (Dark Mode)
                            if (this.currentUser.preferences?.darkMode !== undefined) {
                                this.darkMode = this.currentUser.preferences.darkMode;
                                this.applyTheme();
                            }
                        }
                        else this.logout();
                    } catch (e) { }
                },

                loadScanHistory: async function () {
                    const token = localStorage.getItem('netra_token');
                    if (!token) return;
                    try {
                        const res = await fetch('/scans', { headers: { 'Authorization': `Bearer ${token}` } });
                        if (res.ok) this.scanHistory = await res.json();
                    } catch (e) { }
                },

                deleteScan: async function (id) {
                    if (!confirm("Delete this classified record?")) return;
                    const token = localStorage.getItem('netra_token');
                    try {
                        await fetch(`/scans/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                        this.scanHistory = this.scanHistory.filter(s => s.id !== id);
                    } catch (e) { }
                },

                loadScanForInvestigation: async function (scanStub) {
                    this.selectedScan = scanStub;
                    this.activeTab = 'investigations';

                    // Fetch full details
                    const token = localStorage.getItem('netra_token');
                    try {
                        const res = await fetch(`/scans/${scanStub.id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const fullData = await res.json();
                        this.updateCharts(fullData);
                    } catch (e) { }
                },

                initCharts: function () {
                    if (this.charts.pie) return; // already init

                    const commonOpt = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } };

                    // Pie
                    this.charts.pie = new Chart(document.getElementById('pieChart'), {
                        type: 'doughnut',
                        data: { labels: ['High', 'Med', 'Low'], datasets: [{ data: [0, 0, 0], backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6'] }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#888' } } } }
                    });

                    // Bar
                    this.charts.bar = new Chart(document.getElementById('barChart'), {
                        type: 'bar',
                        data: { labels: ['80', '443', '8080'], datasets: [{ label: 'Ports', data: [0, 0, 0], backgroundColor: '#00f3ff' }] },
                        options: { ...commonOpt, scales: { y: { ticks: { color: '#666' } }, x: { ticks: { color: '#666' } } } }
                    });

                    // Line
                    this.charts.line = new Chart(document.getElementById('lineChart'), {
                        type: 'line',
                        data: { labels: ['Start', 'End'], datasets: [{ label: 'Risk Score', data: [0, 0], borderColor: '#ff00ff', tension: 0.4 }] },
                        options: commonOpt
                    });
                },

                updateCharts: function (scanData) {
                    if (!scanData.results) return;

                    // Update Pie (Vulns)
                    const vulns = scanData.results.ThreatScanner?.vulnerabilities || [];
                    const high = vulns.filter(v => ['High', 'Critical'].includes(v.severity)).length;
                    const med = vulns.filter(v => v.severity === 'Medium').length;
                    const low = vulns.filter(v => ['Low', 'Info'].includes(v.severity)).length;

                    this.charts.pie.data.datasets[0].data = [high || 1, med || 1, low || 1];
                    this.charts.pie.update();

                    // Update Bar (Ports)
                    const ports = scanData.results.PortScanner?.open_ports || [];
                    this.charts.bar.data.labels = ports.map(p => String(p));
                    this.charts.bar.data.datasets[0].data = ports.map(() => 1);
                    this.charts.bar.update();

                    this.fetchStats(); // Refresh global stats immediately
                    this.updateTerminal(scanData);
                },

                // --- AI Terminal Update ---
                updateTerminal: function (scanData) {
                    const terminal = document.getElementById('ai-terminal-text');
                    const allVulns = [
                        ...(scanData.results.ThreatScanner?.vulnerabilities || []),
                        ...(scanData.results.RubyScanner?.vulnerabilities || []),
                        ...(scanData.results.RubyScanner_zombie_scan?.vulnerabilities || [])
                    ];

                    const aiVuln = allVulns.find(v => v.details && v.details.includes("Neural Engine Analysis"));

                    if (aiVuln) {
                        const match = aiVuln.details.match(/Analysis: "(.*?)"/);
                        if (match) {
                            terminal.innerText = "";
                            let i = 0;
                            const txt = match[1];
                            const typeWriter = () => {
                                if (i < txt.length) {
                                    terminal.innerHTML += txt.charAt(i);
                                    i++;
                                    setTimeout(typeWriter, 50);
                                }
                            };
                            typeWriter();
                        }
                    } else if (allVulns.length > 0) {
                        terminal.innerText = `Scan Complete. ${allVulns.length} anomalies detected. Neural Engine Idle.`;
                    } else {
                        terminal.innerText = "Target appears clean. No Shadow APIs detected.";
                    }
                },


                loadDashboardData: function () {
                    this.fetchStats();
                },

                fetchStats: function () {
                    const token = localStorage.getItem('netra_token');
                    if (!token) return;
                    fetch('/api/stats', { headers: { 'Authorization': `Bearer ${token}` } })
                        .then(res => res.json())
                        .then(data => {
                            this.stats = data;
                            // Update Risk Trend Chart
                            if (this.charts.line && data.risk_trend) {
                                this.charts.line.data.datasets[0].data = data.risk_trend;
                                this.charts.line.update();
                            }
                        })
                        .catch(e => console.error(e));
                },

                startScan: async function () {
                    if (!this.target) return;
                    const token = localStorage.getItem('netra_token');
                    this.scanning = true;
                    this.scanStatus = 'DISPATCHING';
                    this.results = null;
                    this.logs = [];
                    this.addLog(`Initializing scan for: ${this.target} `);

                    try {
                        const res = await fetch('/scans', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token} `
                            },
                            body: JSON.stringify({
                                target: this.target,
                                scan_type: 'full',
                                options: this.options
                            })
                        });

                        if (!res.ok) throw new Error('Dispatch failed');
                        const scan = await res.json();
                        this.addLog(`Scan ID ${scan.id} confirmed.`);
                        this.scanStatus = 'IN PROGRESS';

                        // Poll
                        const interval = setInterval(async () => {
                            const r = await fetch(`/ scans / ${scan.id} `, { headers: { 'Authorization': `Bearer ${token} ` } });
                            if (r.ok) {
                                const d = await r.json();
                                if (d.status === 'completed') {
                                    clearInterval(interval);
                                    this.results = d.results;
                                    this.scanning = false;
                                    this.scanStatus = 'COMPLETED';
                                    this.fetchStats();
                                    this.loadScanHistory();
                                } else if (d.status === 'failed') {
                                    clearInterval(interval);
                                    this.scanning = false;
                                    this.scanStatus = 'FAILED';
                                }
                            }
                        }, 2000);

                    } catch (e) {
                        this.addLog(`Error: ${e.message} `);
                        this.scanning = false;
                    }
                },

                addLog: function (msg) {
                    this.logs.unshift(`[${new Date().toLocaleTimeString()}] ${msg} `);
                },

                toggleTheme: function () {
                    this.darkMode = !this.darkMode;
                    this.applyTheme();
                    localStorage.setItem('netra-theme', JSON.stringify(this.darkMode));
                    // Sync to Backend
                    if (this.isAuthenticated) {
                        const token = localStorage.getItem('netra_token');
                        fetch('/users/me/preferences', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ darkMode: this.darkMode })
                        });
                    }
                },

                applyTheme: function () {
                    if (this.darkMode) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                },

                downloadResults: function () {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.results, null, 2));
                    const a = document.createElement('a');
                    a.setAttribute("href", dataStr);
                    a.setAttribute("download", "report.json");
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                },

                monitorGraph: false,
                initGraph: function () {
                    const container = document.getElementById('graph');
                    const width = container.clientWidth;
                    const height = container.clientHeight;



                    const svg = d3.select("#graph").append("svg")
                        .attr("width", width)
                        .attr("height", height)
                        .attr("viewBox", [0, 0, width, height])
                        .attr("style", "max-width: 100%; height: auto;");

                    window.netraGraph.svg = svg; // Capture for external access

                    // Simulation setup
                    const simulation = d3.forceSimulation()
                        .force("link", d3.forceLink().id(d => d.id).distance(100))
                        .force("charge", d3.forceManyBody().strength(-300))
                        .force("center", d3.forceCenter(width / 2, height / 2))
                        .force("collide", d3.forceCollide().radius(30));

                    // Fetch Data
                    const token = localStorage.getItem('netra_token');
                    const statusEl = document.getElementById('graphStatus');
                    if (statusEl) statusEl.innerText = "Connecting to Neural Grid...";

                    fetch('/api/graph', { headers: { 'Authorization': `Bearer ${token} ` } })
                        .then(res => res.json())
                        .then(data => {
                            if (!data.nodes || data.nodes.length === 0) {
                                if (statusEl) statusEl.innerText = "No Active Assets Found";
                                svg.append("text")
                                    .attr("x", width / 2)
                                    .attr("y", height / 2)
                                    .attr("text-anchor", "middle")
                                    .attr("fill", "#666")
                                    .text("No Graph Data Available - Run a Scan");
                                return;
                            }
                            if (statusEl) statusEl.innerText = `Live: ${data.nodes.length} Nodes tracked`;

                            // --- Update Dashboard Charts with Real Data ---
                            try {
                                let high = 0, med = 0, low = 0;
                                let ports = {};
                                let riskScore = 0;

                                data.nodes.forEach(n => {
                                    // Vuln Counts
                                    if (n.group === 'Vulnerability') {
                                        if (n.properties.severity === 'Critical' || n.properties.severity === 'High') high++;
                                        else if (n.properties.severity === 'Medium') med++;
                                        else low++;
                                    }
                                    // Domain Risk
                                    if (n.group === 'Domain' && n.properties.risk_score) {
                                        riskScore = Math.max(riskScore, n.properties.risk_score);
                                    }
                                    // Port Counts
                                    if (n.group === 'Service' && n.label) { // label is port num
                                        ports[n.label] = (ports[n.label] || 0) + 1;
                                    }
                                });

                                // Update Pie (Vulns)
                                if (this.charts.pie) {
                                    this.charts.pie.data.datasets[0].data = [high, med, low];
                                    this.charts.pie.update();
                                }

                                // Update Line (Risk Score - Simulation for now)
                                if (this.charts.line) {
                                    // We only have 1 point (current), so let's flatline it or show transition
                                    this.charts.line.data.datasets[0].data = [riskScore, riskScore];
                                    this.charts.line.update();
                                }

                                // Update Bar (Top Ports)
                                if (this.charts.bar) {
                                    const topPorts = Object.entries(ports).sort((a, b) => b[1] - a[1]).slice(0, 3);
                                    if (topPorts.length > 0) {
                                        this.charts.bar.data.labels = topPorts.map(p => p[0]);
                                        this.charts.bar.data.datasets[0].data = topPorts.map(p => p[1]);
                                        this.charts.bar.update();
                                    }
                                }
                            } catch (e) { console.error("Chart Sync Error", e); }
                            // ----------------------------------------------

                            // Render Links
                            const link = svg.append("g")
                                .attr("stroke", "#999")
                                .attr("stroke-opacity", 0.6)
                                .selectAll("line")
                                .data(data.links)
                                .join("line")
                                .attr("stroke-width", d => Math.sqrt(d.value || 1));

                            // Render Nodes
                            const node = svg.append("g")
                                .attr("stroke", "#fff")
                                .attr("stroke-width", 1.5)
                                .selectAll("circle")
                                .data(data.nodes)
                                .join("circle")
                                .attr("r", d => {
                                    if (d.group === 'Domain') return 15;
                                    if (d.group === 'IPAddress') return 10;
                                    if (d.group === 'Service') return 8;
                                    return 5;
                                })
                                .attr("fill", d => {
                                    // Risk Score coloring
                                    if (d.group === 'Domain' && d.properties.risk_score > 50) return "#ef4444"; // Red
                                    if (d.group === 'Domain') return "#3b82f6"; // Blue
                                    if (d.group === 'Vulnerability') return "#f59e0b"; // Orange
                                    if (d.group === 'IPAddress') return "#10b981"; // Green
                                    if (d.group === 'Service') return "#a855f7"; // Purple
                                    return "#64748b";
                                })
                                .call(d3.drag()
                                    .on("start", dragstarted)
                                    .on("drag", dragged)
                                    .on("end", dragended)
                                    .on("click", (event, d) => {
                                        // Dispatch event to Alpine
                                        window.dispatchEvent(new CustomEvent('node-selected', { detail: d }));
                                    }));

                            node.append("title")
                                .text(d => {
                                    let t = d.label;
                                    if (d.properties.risk_score !== undefined) {
                                        t += `\nRisk Score: ${d.properties.risk_score} `;
                                        if (d.properties.risk_source) t += `\nSource: ${d.properties.risk_source} `;
                                    }
                                    return t;
                                });

                            // Labels
                            const text = svg.append("g")
                                .selectAll("text")
                                .data(data.nodes)
                                .join("text")
                                .text(d => d.label)
                                .attr("font-size", "10px")
                                .attr("fill", "#ccc")
                                .attr("x", 8)
                                .attr("y", 3);

                            simulation
                                .nodes(data.nodes)
                                .on("tick", ticked);

                            simulation.force("link")
                                .links(data.links);

                            function ticked() {
                                link
                                    .attr("x1", d => d.source.x)
                                    .attr("y1", d => d.source.y)
                                    .attr("x2", d => d.target.x)
                                    .attr("y2", d => d.target.y);

                                node
                                    .attr("cx", d => d.x)
                                    .attr("cy", d => d.y);

                                text
                                    .attr("x", d => d.x + 10)
                                    .attr("y", d => d.y + 4);
                            }

                            function dragstarted(event) {
                                if (!event.active) simulation.alphaTarget(0.3).restart();
                                event.subject.fx = event.subject.x;
                                event.subject.fy = event.subject.y;
                            }

                            function dragged(event) {
                                event.subject.fx = event.x;
                                event.subject.fy = event.y;
                            }

                            function dragended(event) {
                                if (!event.active) simulation.alphaTarget(0);
                                event.subject.fx = null;
                                event.subject.fy = null;
                            }
                        })
                        .catch(e => console.error("Graph Error:", e));
                }
            };
        }


        // --- Shadow IT Prediction Logic ---
        async function predictShadowIT() {
            const statusEl = document.getElementById('graphStatus');
            if (statusEl) statusEl.innerText = "Analyzing topology...";

            try {
                const res = await fetch('/api/graph/predict');
                const data = await res.json();

                if (data.predictions && data.predictions.length > 0) {
                    if (statusEl) statusEl.innerText = `AI FOUND ${data.predictions.length} HIDDEN LINKS`;

                    const svg = window.netraGraph.svg;
                    if (!svg) return;

                    // Draw Shadow Links
                    svg.append("g")
                        .attr("class", "shadow-links")
                        .attr("stroke", "#f59e0b") // Yellow-500
                        .attr("stroke-opacity", 0.8)
                        .attr("stroke-dasharray", "5,5") // Dashed
                        .selectAll("line")
                        .data(data.predictions)
                        .join("line")
                        .attr("stroke-width", 2)
                        .attr("x1", d => getCoords(d.source).x)
                        .attr("y1", d => getCoords(d.source).y)
                        .attr("x2", d => getCoords(d.target).x)
                        .attr("y2", d => getCoords(d.target).y)
                        .append("title")
                        .text(d => `⚠️ SHADOW LINK DETECTED\nConfidence: ${d.confidence}%\nReason: ${d.reason}`);

                    // Helper to find node coordinates from IP (since D3 simulation uses object references)
                    // We need to re-select the node data from the D3 internal state or cache it.
                    // A simpler hack: The nodes in the DOM have __data__ attached by D3.

                    function getCoords(ip) {
                        // Find node with matching IP/ID
                        const circle = Array.from(document.querySelectorAll("circle")).find(c => c.__data__.id === ip || c.__data__.label === ip);
                        return circle ? { x: circle.__data__.x, y: circle.__data__.y } : { x: 0, y: 0 };
                    }

                } else {
                    if (statusEl) statusEl.innerText = "No Shadow Links Found";
                }
            } catch (e) {
                console.error("Shadow Scan Error", e);
                if (statusEl) statusEl.innerText = "Prediction Failed";
            }
        }
    </script>
</body>

</html>