<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netra Intelligence Platform</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        radium: { 50: '#e0fbff', 100: '#bdf6ff', 200: '#8aefff', 300: '#46e6ff', 400: '#00d5ff', 500: '#00f3ff', 600: '#008ba3', 800: '#005a6b' },
                        cyber: { black: '#050a14', dark: '#0b1221', border: '#1e293b', text: '#e2e8f0' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                        display: ['Orbitron', 'sans-serif'],
                        serif: ['"Playfair Display"', 'serif'],
                    },
                    animation: {
                        'scan': 'scan 3s linear infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(100%)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [x-cloak] { display: none !important; }
        .glass {
            background: rgba(11, 18, 33, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-light {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .text-glow { text-shadow: 0 0 10px rgba(0, 243, 255, 0.3); }
        .scan-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, #00f3ff, transparent);
            position: absolute;
            animation: scan 2s linear infinite;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-cyber-black text-slate-900 dark:text-cyber-text transition-colors duration-300 min-h-screen font-sans overflow-x-hidden"
      x-data="app()" x-init="initApp()">

    <!-- AUTHENTICATION & LANDING PAGE -->
    <template x-if="!isAuthenticated">
        <div class="fixed inset-0 z-50 flex flex-col md:flex-row h-screen w-full bg-cyber-black overflow-hidden relative">
            <!-- Background Elements -->
            <div class="absolute inset-0 bg-[url('https://res.cloudinary.com/practicaldev/image/fetch/s--_MFOcsk1--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zjvcvp3y03029202512.png')] bg-cover opacity-10 blur-sm pointer-events-none"></div>
            <div class="absolute inset-0 bg-gradient-to-b from-transparent via-cyber-black/80 to-cyber-black pointer-events-none"></div>

            <!-- LEFT: Authentication Form -->
            <div class="w-full md:w-1/2 flex items-center justify-center p-8 md:p-16 relative z-10">
                <div class="w-full max-w-md bg-cyber-dark/80 backdrop-blur-xl border border-slate-700/50 p-10 rounded-2xl shadow-2xl relative overflow-hidden group">
                    <!-- Scan Line -->
                    <div class="absolute top-0 left-0 w-full h-1 bg-radium-500 shadow-[0_0_15px_#00f3ff] opacity-50"></div>
                    
                    <div class="mb-8 text-center">
                        <h1 class="font-display font-bold text-5xl text-white mb-2 tracking-tighter">NETRA</h1>
                        <p class="text-radium-500 font-mono text-xs uppercase tracking-[0.3em]">Surveillance & Intelligence Grid</p>
                    </div>

                    <form @submit.prevent="handleAuth" class="space-y-6">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Agent Identity</label>
                            <div class="relative">
                                <i data-lucide="user" class="absolute left-3 top-3 w-5 h-5 text-slate-500"></i>
                                <input type="text" x-model="authForm.username" required 
                                       class="w-full bg-black/50 border border-slate-700 rounded pl-10 pr-4 py-3 text-white font-mono placeholder-slate-600 focus:border-radium-500 focus:ring-1 focus:ring-radium-500 transition-all outline-none"
                                       placeholder="Enter user ID">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Access Key</label>
                            <div class="relative">
                                <i data-lucide="lock" class="absolute left-3 top-3 w-5 h-5 text-slate-500"></i>
                                <input type="password" x-model="authForm.password" required 
                                       class="w-full bg-black/50 border border-slate-700 rounded pl-10 pr-4 py-3 text-white font-mono placeholder-slate-600 focus:border-radium-500 focus:ring-1 focus:ring-radium-500 transition-all outline-none"
                                       placeholder="••••••••">
                            </div>
                        </div>

                        <button type="submit" 
                                class="w-full bg-radium-600 hover:bg-radium-500 text-black font-display font-bold uppercase tracking-widest py-4 rounded transition-all transform hover:scale-[1.02] shadow-[0_0_20px_rgba(0,243,255,0.3)] flex items-center justify-center gap-2">
                            <span x-text="authMode === 'login' ? 'Establish Link' : 'Register Identity'"></span>
                            <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                    </form>

                    <div class="mt-6 text-center border-t border-slate-800 pt-4">
                        <button @click="authMode = authMode === 'login' ? 'register' : 'login'" 
                                class="text-xs text-slate-400 hover:text-white transition-colors">
                            <span x-text="authMode === 'login' ? 'Request New Clearance (Register)' : 'Return to Login'"></span>
                        </button>
                    </div>
                     <div x-show="authError" class="mt-4 p-3 bg-red-900/30 border border-red-500 rounded text-red-400 text-xs text-center font-mono" x-text="authError"></div>
                </div>
            </div>

            <!-- RIGHT: Instructions & Safety -->
            <div class="hidden md:flex w-1/2 bg-slate-900/50 backdrop-blur-md border-l border-slate-800 p-16 flex-col justify-center relative">
                <div class="max-w-lg mx-auto space-y-12">
                    
                    <!-- Safety Warning -->
                    <div class="border-l-4 border-red-500 pl-6 py-2">
                        <h3 class="text-red-500 font-display font-bold text-2xl mb-2 flex items-center gap-2">
                            <i data-lucide="shield-alert" class="w-6 h-6"></i> Authorized Use Only
                        </h3>
                        <p class="text-slate-400 text-sm leading-relaxed text-justify">
                            This system allows for active reconnaissance and simulated engagement. 
                            Unauthorized use against targets without explicit written consent is a violation of federal and international law (CFAA, GDPR). 
                            All actions are logged and auditable. Proceed only for authorized security testing or educational research.
                        </p>
                    </div>

                    <!-- App Overview -->
                    <div class="space-y-6">
                        <h3 class="text-white font-display font-bold text-xl uppercase tracking-widest border-b border-slate-700 pb-2">System Capabilities</h3>
                        
                        <div class="flex gap-4 items-start">
                            <div class="p-2 rounded bg-blue-900/20 text-blue-400 mt-1"><i data-lucide="scan" class="w-5 h-5"></i></div>
                            <div>
                                <h4 class="text-white font-bold text-sm">Deep Reconnaissance</h4>
                                <p class="text-slate-500 text-xs mt-1">Automated asset discovery, port scanning, and banner grabbing via distributed drones.</p>
                            </div>
                        </div>

                         <div class="flex gap-4 items-start">
                            <div class="p-2 rounded bg-purple-900/20 text-purple-400 mt-1"><i data-lucide="network" class="w-5 h-5"></i></div>
                            <div>
                                <h4 class="text-white font-bold text-sm">Graph Visualization</h4>
                                <p class="text-slate-500 text-xs mt-1">Real-time Neo4j mapping of infrastructure relationships and potential attack vectors.</p>
                            </div>
                        </div>

                         <div class="flex gap-4 items-start">
                            <div class="p-2 rounded bg-red-900/20 text-red-400 mt-1"><i data-lucide="zap" class="w-5 h-5"></i></div>
                            <div>
                                <h4 class="text-white font-bold text-sm">Polyglot Scanning</h4>
                                <p class="text-slate-500 text-xs mt-1">Hybrid Python/Ruby engine capable of running legacy exploit scripts (Metasploit/WPScan simulation).</p>
                            </div>
                        </div>
                    </div>

                    <div class="pt-12 text-center">
                        <p class="font-mono text-[10px] text-slate-600">SECURE TERMINAL ACCESS // V2.0.4-BETA</p>
                    </div>

                </div>
            </div>
        </div>
    </template>

    <!-- MAIN DASHBOARD CONTENT (Authenticated) -->
    <main x-show="isAuthenticated" x-cloak class="min-h-screen flex flex-col">
        
        <!-- Header / Masthead -->
        <header class="border-b-4 border-double border-slate-900 dark:border-slate-700 bg-white dark:bg-cyber-black relative z-40">
            <!-- Top Utility Bar -->
            <div class="flex items-center justify-between px-4 md:px-8 py-2 border-b border-slate-300 dark:border-slate-800 text-xs font-serif italic text-slate-600 dark:text-slate-400">
                <div class="flex items-center gap-4">
                    <span x-text="new Date().toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })"></span>
                    <span class="hidden md:inline">|</span>
                    <span class="hidden md:inline">Vol. 2, No. 42</span>
                     <span class="hidden md:inline">|</span>
                    <span class="hidden md:inline">Data Isolation: ACTIVE</span>
                </div>
                <div class="flex items-center gap-4">
                    <button @click="toggleTheme()" class="hover:text-radium-500 transition-colors">
                        <i data-lucide="sun" x-show="!darkMode" class="w-4 h-4"></i>
                        <i data-lucide="moon" x-show="darkMode" class="w-4 h-4"></i>
                    </button>
                    <div class="flex items-center gap-2 group cursor-pointer relative" @click="logout()">
                         <i data-lucide="user" class="w-3 h-3"></i>
                        <span class="font-bold uppercase" x-text="currentUser?.username || 'AGENT'"></span>
                        <span class="text-[10px] opacity-0 group-hover:opacity-100 transition-opacity text-red-500 ml-1">(LOGOUT)</span>
                    </div>
                </div>
            </div>

            <!-- Title -->
            <div class="py-6 text-center relative overflow-hidden group">
                <h1 class="text-4xl md:text-7xl font-serif font-black tracking-tighter text-slate-900 dark:text-slate-100 mb-2 relative z-10 selection:bg-radium-500 selection:text-black">
                    The Netra Times
                </h1>
                <div class="h-1 w-24 bg-slate-900 dark:bg-slate-100 mx-auto mb-1"></div>
                <div class="h-0.5 w-full max-w-xl bg-slate-900 dark:bg-slate-100 mx-auto"></div>
                <p class="mt-2 font-display text-xs tracking-[0.3em] text-slate-500 dark:text-radium-500 uppercase">
                    Advanced Security Monitoring & Intelligence
                </p>
                 <!-- BG Decor -->
                <i data-lucide="shield" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-48 text-slate-200/50 dark:text-slate-800/20 -z-0 opacity-20 rotate-12"></i>
            </div>

            <!-- NavBar -->
            <nav class="flex justify-center border-t border-b border-slate-300 dark:border-slate-700 py-3 sticky top-0 bg-white/95 dark:bg-cyber-black/95 backdrop-blur z-50">
                <ul class="flex flex-wrap justify-center gap-4 md:gap-8 px-4">
                    <template x-for="item in menuItems" :key="item.id">
                        <li>
                            <button @click="activeTab = item.id" 
                                    :class="activeTab === item.id ? 'text-radium-600 dark:text-radium-500 scale-105' : 'text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200'"
                                    class="relative px-2 py-1 font-serif text-sm md:text-base font-bold tracking-wider transition-all duration-300">
                                <span x-text="item.label"></span>
                                <div x-show="activeTab === item.id" class="absolute -bottom-2 left-0 right-0 h-0.5 bg-radium-600 dark:bg-radium-500"></div>
                            </button>
                        </li>
                    </template>
                </ul>
            </nav>
        </header>

         <!-- DASHBOARD CONTENT -->
         <div class="flex-grow max-w-7xl mx-auto w-full p-4 md:p-8">
            
            <!-- VIEW: FRONT PAGE -->
            <div x-show="activeTab === 'dashboard'" x-transition.opacity.duration.300ms>
                <!-- Existing Dashboard Layout -->
                 <div class="mb-6 border-b-2 border-slate-900 dark:border-slate-100 pb-2">
                    <div class="flex flex-wrap gap-4 justify-between items-end">
                        <div class="flex items-center gap-2">
                            <span class="bg-red-600 text-white px-2 py-0.5 font-bold text-[10px] uppercase tracking-widest animate-pulse">LIVE FEED</span>
                            <span class="font-serif italic text-sm text-slate-700 dark:text-slate-300">System functionality restored. Agent login confirmed.</span>
                        </div>
                         <div class="font-mono text-[10px] text-slate-500">
                            SCANS {<span x-text="stats.scans"></span>} | VULNS {<span x-text="stats.vulns"></span>} | ASSETS {<span x-text="stats.assets"></span>}
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <!-- Left: Controls -->
                    <div class="lg:col-span-5 space-y-6">
                        <div class="bg-white dark:bg-cyber-dark p-6 shadow-xl border border-slate-200 dark:border-slate-800 relative">
                             <div class="border-b-4 border-double border-slate-800 dark:border-slate-600 mb-4 pb-2">
                                <h2 class="font-serif font-black text-2xl text-slate-900 dark:text-slate-100 leading-none">TARGET ACQUISITION</h2>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block font-sans text-xs font-bold uppercase tracking-widest mb-1 text-slate-500">Target URI</label>
                                <input type="text" x-model="target" placeholder="example.com" 
                                       class="w-full bg-slate-100 dark:bg-black border-b-2 border-slate-800 dark:border-slate-200 px-4 py-2 text-xl font-serif text-slate-900 dark:text-white focus:outline-none focus:bg-yellow-50 dark:focus:bg-gray-900 transition-colors">
                            </div>

                            <div class="bg-slate-100 dark:bg-black p-4 border border-slate-300 dark:border-slate-700 mb-6">
                                <h3 class="font-sans font-bold text-xs uppercase text-slate-500 mb-2 border-b border-slate-300 pb-1">Scan Profiles</h3>
                                <div class="grid grid-cols-2 gap-y-2">
                                    <template x-for="(val, key) in options" :key="key">
                                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-800 p-1 rounded">
                                            <input type="checkbox" x-model="options[key]" class="text-slate-900 rounded-none w-4 h-4">
                                            <span x-text="key" class="font-serif text-sm text-slate-700 dark:text-slate-300 italic"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>

                             <button @click="startScan()" :disabled="scanning" 
                                    class="w-full py-4 border-2 border-slate-900 dark:border-white font-bold font-sans tracking-widest uppercase transition-all hover:bg-slate-900 hover:text-white dark:hover:bg-white dark:hover:text-black disabled:opacity-50 disabled:cursor-not-allowed mb-2">
                                <span x-text="scanning ? 'TRANSMITTING...' : 'LAUNCH OPERATION'"></span>
                            </button>
                             <div x-show="scanning" class="text-center font-mono text-xs text-radium-600 animate-pulse">STATUS: <span x-text="scanStatus"></span></div>

                             <!-- Logs -->
                             <div x-show="logs.length > 0" class="mt-4 p-2 bg-black text-green-400 font-mono text-[10px] h-32 overflow-y-auto border border-slate-700">
                                <template x-for="log in logs">
                                    <div x-text="log"></div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Results -->
                    <div class="lg:col-span-7">
                        <div class="bg-white dark:bg-cyber-dark shadow-2xl p-8 min-h-[500px] border border-slate-200 dark:border-slate-800 relative">
                             <div class="text-center mb-6">
                                <h2 class="font-serif font-bold text-3xl mb-1 text-slate-900 dark:text-white">Analysis Report</h2>
                                <div class="flex justify-center items-center gap-4 text-[10px] font-sans font-bold text-slate-400 uppercase tracking-widest">
                                    <span>Intelligence Division</span>
                                    <span>&bull;</span>
                                    <span x-text="new Date().toLocaleDateString()"></span>
                                </div>
                            </div>

                            <div x-show="!results" class="flex flex-col items-center justify-center h-48 border-4 border-double border-slate-200 dark:border-slate-700 p-8 text-center text-slate-400 italic font-serif">
                                <i data-lucide="shield" class="w-12 h-12 mb-4" :class="scanning ? 'animate-pulse text-slate-800 dark:text-white' : ''"></i>
                                <span x-text="scanning ? 'Receiving transmission...' : 'Awaiting Mission Directives.'"></span>
                            </div>

                            <div x-show="results" class="space-y-6 text-sm">
                                <!-- Quick Stats -->
                                <div class="grid grid-cols-3 gap-4 border-b border-slate-700 pb-4 mb-4">
                                    <div class="text-center">
                                        <div class="text-xs text-slate-500 uppercase">Ports</div>
                                        <div class="text-2xl font-mono" x-text="results?.PortScanner?.open_ports?.length || 0"></div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-slate-500 uppercase">Threats</div>
                                        <div class="text-2xl font-mono text-red-500" x-text="results?.ThreatScanner?.vulnerabilities?.length || 0"></div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-slate-500 uppercase">Latency</div>
                                        <div class="text-2xl font-mono text-green-500">42ms</div>
                                    </div>
                                </div>

                                <!-- Vuln List -->
                                <template x-for="v in results?.ThreatScanner?.vulnerabilities || []">
                                    <div class="border-l-4 border-red-500 pl-4 py-1">
                                         <h4 class="font-bold text-red-500" x-text="v.type"></h4>
                                         <p class="text-slate-400 text-xs" x-text="v.details"></p>
                                    </div>
                                </template>
                                
                                <div x-show="results" class="mt-4 pt-4 border-t border-slate-700 flex justify-end">
                                     <button @click="downloadResults()" class="text-xs font-bold uppercase hover:text-radium-500 flex items-center gap-2">
                                        <i data-lucide="download" class="w-4 h-4"></i> Export JSON
                                     </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

             <!-- VIEW: INVESTIGATIONS (Graph) -->
            <div x-show="activeTab === 'graph'" x-transition.opacity.duration.300ms>
                 <div class="h-[600px] w-full bg-cyber-black overflow-hidden rounded-xl border border-cyber-border relative">
                     <canvas id="graphCanvas" class="w-full h-full opacity-80"></canvas>
                      <div class="absolute top-4 left-4 pointer-events-none">
                        <h2 class="text-2xl font-display font-bold text-white">Asset Graph</h2>
                         <p class="text-slate-400 text-xs">Knowledge Graph Visualization</p>
                    </div>
                 </div>
            </div>

            <!-- VIEW: ARCHIVES -->
            <div x-show="activeTab === 'settings'" class="max-w-2xl mx-auto bg-white dark:bg-cyber-dark p-8 shadow-xl">
                 <h2 class="text-2xl font-serif font-bold mb-4 dark:text-white">Archives & Settings</h2>
                 <p class="mb-4 text-slate-500">Manage user specific configurations and historic data.</p>
                 <button @click="logout()" class="bg-red-600 text-white px-4 py-2 uppercase font-bold text-xs tracking-widest hover:bg-red-700"> Terminate Session (Logout) </button>
            </div>

         </div>

    </main>

    <!-- App Logic -->
    <script>
        function app() {
            return {
                isAuthenticated: false,
                authMode: 'login',
                authForm: { username: '', password: '' },
                authError: null,
                currentUser: null,
                
                activeTab: 'dashboard',
                darkMode: true,
                target: '',
                scanning: false,
                scanStatus: 'IDLE',
                logs: [],
                results: null,
                stats: { scans: 0, vulns: 0, assets: 0 },
                options: { Cloud: false, IoT: false, GraphQL: false, Acquisitions: false, AutoExploit: false },
                
                menuItems: [
                    { id: 'dashboard', label: 'FRONT PAGE' },
                    { id: 'graph', label: 'INVESTIGATIONS' },
                    { id: 'settings', label: 'ARCHIVES' },
                ],
                
                initApp() {
                    const savedTheme = localStorage.getItem('netra-theme');
                    this.darkMode = savedTheme ? JSON.parse(savedTheme) : true;
                    this.applyTheme();
                    this.checkAuth();
                    this.$nextTick(() => lucide.createIcons());
                    
                    this.$watch('activeTab', (val) => {
                         this.$nextTick(() => lucide.createIcons());
                         if(val === 'graph') setTimeout(() => this.initGraph(), 100);
                    });
                },

                checkAuth() {
                    const token = localStorage.getItem('netra_token');
                    if (token) {
                        this.isAuthenticated = true;
                        this.fetchUserProfile();
                        this.loadDashboardData();
                    }
                },

                async handleAuth() {
                    this.authError = null;
                    const endpoint = this.authMode === 'login' ? '/token' : '/auth/register';
                    const formData = new URLSearchParams();
                    formData.append('username', this.authForm.username);
                    formData.append('password', this.authForm.password);

                    try {
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: formData
                        });
                        
                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || 'Access Denied');
                        }

                        const data = await res.json();
                        localStorage.setItem('netra_token', data.access_token);
                        this.isAuthenticated = true;
                        this.authForm = { username: '', password: '' }; // Clear
                        this.loadDashboardData();
                        this.fetchUserProfile();

                    } catch (e) {
                        this.authError = e.message;
                    }
                },

                logout() {
                    localStorage.removeItem('netra_token');
                    this.isAuthenticated = false;
                    this.results = null;
                },

                 async fetchUserProfile() {
                    const token = localStorage.getItem('netra_token');
                    if (!token) return;
                    try {
                        const res = await fetch('/users/me', { headers: { 'Authorization': `Bearer ${token}` } });
                        if (res.ok) this.currentUser = await res.json();
                        else this.logout();
                    } catch (e) {}
                },

                loadDashboardData() {
                    this.fetchStats();
                },

                fetchStats() {
                    const token = localStorage.getItem('netra_token');
                    if(!token) return;
                     fetch('/api/stats', { headers: { 'Authorization': `Bearer ${token}` } })
                        .then(res => res.json())
                        .then(data => this.stats = data)
                        .catch(e => console.error(e));
                },

                async startScan() {
                    if (!this.target) return;
                    const token = localStorage.getItem('netra_token');
                    this.scanning = true;
                    this.scanStatus = 'DISPATCHING';
                    this.results = null;
                    this.logs = [];
                    this.addLog(`Initializing scan for: ${this.target}`);

                    try {
                        const res = await fetch('/scans', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                target: this.target,
                                scan_type: 'full',
                                options: this.options
                            })
                        });

                        if (!res.ok) throw new Error('Dispatch failed');
                        const scan = await res.json();
                        this.addLog(`Scan ID ${scan.id} confirmed.`);
                        this.scanStatus = 'IN PROGRESS';
                        
                        // Poll
                        const interval = setInterval(async () => {
                             const r = await fetch(`/scans/${scan.id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                             if(r.ok) {
                                 const d = await r.json();
                                 if(d.status === 'completed') {
                                     clearInterval(interval);
                                     this.results = d.results;
                                     this.scanning = false;
                                     this.scanStatus = 'COMPLETED';
                                     this.fetchStats();
                                 } else if (d.status === 'failed') {
                                     clearInterval(interval);
                                     this.scanning = false;
                                     this.scanStatus = 'FAILED';
                                 }
                             }
                        }, 2000);

                    } catch (e) {
                        this.addLog(`Error: ${e.message}`);
                        this.scanning = false;
                    }
                },

                addLog(msg) {
                    this.logs.unshift(`[${new Date().toLocaleTimeString()}] ${msg}`);
                },
                
                toggleTheme() {
                    this.darkMode = !this.darkMode;
                    this.applyTheme();
                    localStorage.setItem('netra-theme', JSON.stringify(this.darkMode));
                },
                
                applyTheme() {
                     if (this.darkMode) document.documentElement.classList.add('dark');
                     else document.documentElement.classList.remove('dark');
                },

                downloadResults() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.results, null, 2));
                    const a = document.createElement('a');
                    a.setAttribute("href", dataStr);
                    a.setAttribute("download", "report.json");
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                },

                monitorGraph: false,
                initGraph() {
                     const canvas = document.getElementById('graphCanvas');
                     if(!canvas) return;
                     // Simple particle simulation
                     const ctx = canvas.getContext('2d');
                     canvas.width = canvas.parentElement.offsetWidth;
                     canvas.height = canvas.parentElement.offsetHeight;
                     
                     let nodes = [];
                     for(let i=0; i<30; i++) {
                         nodes.push({
                             x: Math.random() * canvas.width,
                             y: Math.random() * canvas.height,
                             vx: (Math.random()-0.5)*0.5,
                             vy: (Math.random()-0.5)*0.5,
                             color: Math.random() > 0.5 ? '#00f3ff' : '#ff00ff'
                         })
                     }

                     const animate = () => {
                         if(this.activeTab !== 'graph') return; 
                         ctx.clearRect(0,0,canvas.width, canvas.height);
                         nodes.forEach(p => {
                             p.x += p.vx; p.y += p.vy;
                             if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
                             if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
                             ctx.beginPath();
                             ctx.arc(p.x, p.y, 2, 0, Math.PI*2);
                             ctx.fillStyle = p.color;
                             ctx.fill();
                         });
                         // Links
                         ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                         ctx.beginPath();
                         for(let i=0; i<nodes.length; i++) {
                             for(let j=i+1; j<nodes.length; j++) {
                                 const dx = nodes[i].x - nodes[j].x;
                                 const dy = nodes[i].y - nodes[j].y;
                                 if(Math.sqrt(dx*dx + dy*dy) < 100) {
                                     ctx.moveTo(nodes[i].x, nodes[i].y);
                                     ctx.lineTo(nodes[j].x, nodes[j].y);
                                 }
                             }
                         }
                         ctx.stroke();
                         requestAnimationFrame(animate);
                     }
                     animate();
                }
            }
        }
    </script>
</body>
</html>