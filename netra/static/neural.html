<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NETRA: Neural Grid (Live)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #050505;
            color: #e2e8f0;
        }

        /* Scanline effect */
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0) 0%, rgba(34, 197, 94, 0.05) 50%, rgba(0, 0, 0, 0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% {
                bottom: 100%;
            }

            80% {
                bottom: -100%;
            }

            100% {
                bottom: -100%;
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden relative">
    <div class="scanline"></div>

    <!-- Top Nav -->
    <header class="h-16 border-b border-white/10 flex items-center justify-between px-6 bg-black/40 backdrop-blur-md z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-green-500/20 flex items-center justify-center border border-green-500/50 animate-pulse">
                <i data-lucide="network" class="text-green-400 w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white leading-none">NEURAL <span class="text-green-400">GRID</span></h1>
                <p class="text-[10px] text-slate-500 font-mono tracking-widest uppercase" id="status-text">Connecting...</p>
            </div>
        </div>
        
        <div class="flex gap-4 items-center">
             <div class="flex gap-2 text-xs font-mono text-slate-400">
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Domain</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> IP</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-purple-500"></span> Service</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> High Risk</span>
             </div>

            <a href="/" class="px-3 py-1.5 rounded border border-white/10 bg-white/5 hover:bg-white/10 text-xs text-white transition-colors flex items-center gap-2">
                <i data-lucide="arrow-left" class="w-3 h-3"></i> Dashboard
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative bg-[radial-gradient(circle_at_center,rgba(20,20,30,1)_0%,rgba(5,5,5,1)_100%)]">
        
        <!-- Graph Container -->
        <div id="graph-container" class="absolute inset-0 z-0 cursor-move"></div>

        <!-- Float Overlay -->
        <div class="absolute bottom-6 left-6 z-10 w-80 bg-black/60 backdrop-blur border border-white/10 rounded-lg p-4">
            <h3 class="text-sm font-bold text-green-400 mb-2 flex items-center gap-2">
                <i data-lucide="activity" class="w-4 h-4"></i> Live Analysis
            </h3>
            <div id="ai-insights" class="space-y-2 text-xs text-slate-300 font-mono max-h-32 overflow-y-auto">
                <p>> Initializing visualization engine...</p>
            </div>
        </div>

    </main>

    <script>
        lucide.createIcons();

        // --- D3 Graph Logic ---
        async function initGraph() {
            const container = document.getElementById('graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Clear
            container.innerHTML = "";

            const svg = d3.select("#graph-container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [0, 0, width, height]);

            // Simulation
            const simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(d => d.id).distance(80))
                .force("charge", d3.forceManyBody().strength(-200))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collide", d3.forceCollide().radius(25));

            // Fetch Data
            try {
                const token = localStorage.getItem('netra_token');
                if (!token) {
                    window.location.href = '/'; // Kick back if not authed
                    return;
                }

                const res = await fetch('/api/graph', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                updateStatus(data.nodes?.length || 0);

                if (!data.nodes || data.nodes.length === 0) {
                     svg.append("text")
                        .attr("x", width / 2)
                        .attr("y", height / 2)
                        .attr("text-anchor", "middle")
                        .attr("fill", "#444")
                        .attr("font-family", "monospace")
                        .attr("font-size", "14px")
                        .text("[ NO SIGNAL ] - Initiating Scan Sequence Required");
                    return;
                }

                logInsight(`Received ${data.nodes.length} nodes and ${data.links.length} connections.`);

                // Render Links
                const link = svg.append("g")
                    .attr("stroke", "#334155")
                    .attr("stroke-opacity", 0.6)
                    .selectAll("line")
                    .data(data.links)
                    .join("line")
                    .attr("stroke-width", d => Math.sqrt(d.value || 1));

                // Render Nodes
                const node = svg.append("g")
                    .attr("stroke", "#000")
                    .attr("stroke-width", 1.5)
                    .selectAll("circle")
                    .data(data.nodes)
                    .join("circle")
                    .attr("r", d => getNodeSize(d.group))
                    .attr("fill", d => getNodeColor(d))
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));

                // Labels
                const text = svg.append("g")
                    .selectAll("text")
                    .data(data.nodes)
                    .join("text")
                    .text(d => d.label)
                    .attr("font-size", "10px")
                    .attr("fill", "#94a3b8")
                    .attr("dx", 12)
                    .attr("dy", 4);

                // Titles
                node.append("title")
                    .text(d => `${d.group}\n${d.label}\nRisk: ${d.properties.risk_score || 'N/A'}`);

                // Ticker
                simulation
                    .nodes(data.nodes)
                    .on("tick", ticked);

                simulation.force("link")
                    .links(data.links);

                function ticked() {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("cx", d => d.x)
                        .attr("cy", d => d.y);

                    text
                         .attr("x", d => d.x)
                         .attr("y", d => d.y);
                }

                // Drag functions
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }

                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }

            } catch (e) {
                console.error("Graph Error:", e);
                logInsight("Error connecting to neural uplink.");
            }
        }

        // Helpers
        function getNodeSize(group) {
            if (group === 'Domain') return 12;
            if (group === 'IPAddress') return 8;
            if (group === 'Service') return 6;
            return 5;
        }

        function getNodeColor(d) {
             if (d.group === 'Domain' && d.properties.risk_score > 50) return "#ef4444"; // Red
             if (d.group === 'Domain') return "#3b82f6"; // Blue
             if (d.group === 'Vulnerability') return "#f59e0b"; // Orange
             if (d.group === 'IPAddress') return "#10b981"; // Green
             if (d.group === 'Service') return "#a855f7"; // Purple
             return "#64748b";
        }

        function updateStatus(count) {
            const el = document.getElementById('status-text');
            if(count > 0) {
                 el.innerText = `LINK ESTABLISHED â€¢ ${count} NODES ACTIVE`;
                 el.classList.add('text-green-500');
            } else {
                 el.innerText = `NO SIGNAL`;
                 el.classList.add('text-red-500');
            }
        }

        function logInsight(msg) {
             const feed = document.getElementById('ai-insights');
             const p = document.createElement('p');
             p.innerText = `> ${msg}`;
             feed.prepend(p);
        }

        // Start
        initGraph();
        
        // Handle Resize
        window.addEventListener('resize', initGraph);

    </script>
</body>

</html>